{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport { getAppEventName, SharedEventEmitter } from \"../../utils/events\";\nimport { getNativeModule } from \"../../utils/native\";\nimport Transaction from \"./Transaction\";\nvar transactionId = 0;\n\nvar generateTransactionId = function generateTransactionId() {\n  return transactionId++;\n};\n\nvar TransactionHandler = function () {\n  function TransactionHandler(firestore) {\n    _classCallCheck(this, TransactionHandler);\n\n    this._pending = {};\n    this._firestore = firestore;\n    SharedEventEmitter.addListener(getAppEventName(this._firestore, 'firestore_transaction_event'), this._handleTransactionEvent.bind(this));\n  }\n\n  _createClass(TransactionHandler, [{\n    key: \"_add\",\n    value: function _add(updateFunction) {\n      var _this = this;\n\n      var id = generateTransactionId();\n      var meta = {\n        id: id,\n        updateFunction: updateFunction,\n        stack: new Error().stack.split('\\n').slice(2).join('\\n')\n      };\n      this._pending[id] = {\n        meta: meta,\n        transaction: new Transaction(this._firestore, meta)\n      };\n      return new Promise(function (resolve, reject) {\n        getNativeModule(_this._firestore).transactionBegin(id);\n\n        meta.resolve = function (r) {\n          resolve(r);\n\n          _this._remove(id);\n        };\n\n        meta.reject = function (e) {\n          reject(e);\n\n          _this._remove(id);\n        };\n      });\n    }\n  }, {\n    key: \"_remove\",\n    value: function _remove(id) {\n      getNativeModule(this._firestore).transactionDispose(id);\n      delete this._pending[id];\n    }\n  }, {\n    key: \"_handleTransactionEvent\",\n    value: function _handleTransactionEvent(event) {\n      switch (event.type) {\n        case 'update':\n          this._handleUpdate(event);\n\n          break;\n\n        case 'error':\n          this._handleError(event);\n\n          break;\n\n        case 'complete':\n          this._handleComplete(event);\n\n          break;\n      }\n    }\n  }, {\n    key: \"_handleUpdate\",\n    value: function _handleUpdate(event) {\n      var id, _this$_pending$id, meta, transaction, updateFunction, reject, finalError, updateFailed, pendingResult, possiblePromise;\n\n      return _regeneratorRuntime.async(function _handleUpdate$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              id = event.id;\n\n              if (this._pending[id]) {\n                _context.next = 3;\n                break;\n              }\n\n              return _context.abrupt(\"return\", this._remove(id));\n\n            case 3:\n              _this$_pending$id = this._pending[id], meta = _this$_pending$id.meta, transaction = _this$_pending$id.transaction;\n              updateFunction = meta.updateFunction, reject = meta.reject;\n\n              transaction._prepare();\n\n              _context.prev = 6;\n              possiblePromise = updateFunction(transaction);\n\n              if (!(!possiblePromise || !possiblePromise.then)) {\n                _context.next = 12;\n                break;\n              }\n\n              finalError = new Error('Update function for `firestore.runTransaction(updateFunction)` must return a Promise.');\n              _context.next = 15;\n              break;\n\n            case 12:\n              _context.next = 14;\n              return _regeneratorRuntime.awrap(possiblePromise);\n\n            case 14:\n              pendingResult = _context.sent;\n\n            case 15:\n              _context.next = 21;\n              break;\n\n            case 17:\n              _context.prev = 17;\n              _context.t0 = _context[\"catch\"](6);\n              updateFailed = true;\n              finalError = _context.t0;\n\n            case 21:\n              if (!(updateFailed || finalError)) {\n                _context.next = 23;\n                break;\n              }\n\n              return _context.abrupt(\"return\", reject(finalError));\n\n            case 23:\n              transaction._pendingResult = pendingResult;\n              return _context.abrupt(\"return\", getNativeModule(this._firestore).transactionApplyBuffer(id, transaction._commandBuffer));\n\n            case 25:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, this, [[6, 17]], Promise);\n    }\n  }, {\n    key: \"_handleError\",\n    value: function _handleError(event) {\n      var id = event.id,\n          error = event.error;\n      var meta = this._pending[id].meta;\n\n      if (meta && error) {\n        var code = error.code,\n            message = error.message;\n        var errorWithStack = new Error(message);\n        errorWithStack.code = code;\n        errorWithStack.stack = \"Error: \" + message + \"\\n\" + meta.stack;\n        meta.reject(errorWithStack);\n      }\n    }\n  }, {\n    key: \"_handleComplete\",\n    value: function _handleComplete(event) {\n      var id = event.id;\n      var _this$_pending$id2 = this._pending[id],\n          meta = _this$_pending$id2.meta,\n          transaction = _this$_pending$id2.transaction;\n\n      if (meta) {\n        var pendingResult = transaction._pendingResult;\n        meta.resolve(pendingResult);\n      }\n    }\n  }]);\n\n  return TransactionHandler;\n}();\n\nexport { TransactionHandler as default };","map":{"version":3,"names":["getAppEventName","SharedEventEmitter","getNativeModule","Transaction","transactionId","generateTransactionId","TransactionHandler","firestore","_pending","_firestore","addListener","_handleTransactionEvent","bind","updateFunction","id","meta","stack","Error","split","slice","join","transaction","Promise","resolve","reject","transactionBegin","r","_remove","e","transactionDispose","event","type","_handleUpdate","_handleError","_handleComplete","_prepare","possiblePromise","then","finalError","pendingResult","updateFailed","_pendingResult","transactionApplyBuffer","_commandBuffer","error","code","message","errorWithStack"],"sources":["C:/Users/PC/Desktop/All/StoreApp2/my-app/node_modules/react-native-firebase/dist/modules/firestore/TransactionHandler.js"],"sourcesContent":["/**\n * \n * Firestore Transaction representation wrapper\n */\nimport { getAppEventName, SharedEventEmitter } from '../../utils/events';\nimport { getNativeModule } from '../../utils/native';\nimport Transaction from './Transaction';\nlet transactionId = 0;\n/**\n * Uses the push id generator to create a transaction id\n * @returns {number}\n * @private\n */\n\nconst generateTransactionId = () => transactionId++;\n\n/**\n * @class TransactionHandler\n */\nexport default class TransactionHandler {\n  constructor(firestore) {\n    this._pending = {};\n    this._firestore = firestore;\n    SharedEventEmitter.addListener(getAppEventName(this._firestore, 'firestore_transaction_event'), this._handleTransactionEvent.bind(this));\n  }\n  /**\n   * -------------\n   * INTERNAL API\n   * -------------\n   */\n\n  /**\n   * Add a new transaction and start it natively.\n   * @param updateFunction\n   */\n\n\n  _add(updateFunction) {\n    const id = generateTransactionId(); // $FlowExpectedError: Transaction has to be populated\n\n    const meta = {\n      id,\n      updateFunction,\n      stack: new Error().stack.split('\\n').slice(2).join('\\n')\n    };\n    this._pending[id] = {\n      meta,\n      transaction: new Transaction(this._firestore, meta)\n    }; // deferred promise\n\n    return new Promise((resolve, reject) => {\n      getNativeModule(this._firestore).transactionBegin(id);\n\n      meta.resolve = r => {\n        resolve(r);\n\n        this._remove(id);\n      };\n\n      meta.reject = e => {\n        reject(e);\n\n        this._remove(id);\n      };\n    });\n  }\n  /**\n   * Destroys a local instance of a transaction meta\n   *\n   * @param id\n   * @private\n   */\n\n\n  _remove(id) {\n    getNativeModule(this._firestore).transactionDispose(id);\n    delete this._pending[id];\n  }\n  /**\n   * -------------\n   *    EVENTS\n   * -------------\n   */\n\n  /**\n   * Handles incoming native transaction events and distributes to correct\n   * internal handler by event.type\n   *\n   * @param event\n   * @returns {*}\n   * @private\n   */\n\n\n  _handleTransactionEvent(event) {\n    // eslint-disable-next-line default-case\n    switch (event.type) {\n      case 'update':\n        this._handleUpdate(event);\n\n        break;\n\n      case 'error':\n        this._handleError(event);\n\n        break;\n\n      case 'complete':\n        this._handleComplete(event);\n\n        break;\n    }\n  }\n  /**\n   * Handles incoming native transaction update events\n   *\n   * @param event\n   * @private\n   */\n\n\n  async _handleUpdate(event) {\n    const {\n      id\n    } = event; // abort if no longer exists js side\n\n    if (!this._pending[id]) return this._remove(id);\n    const {\n      meta,\n      transaction\n    } = this._pending[id];\n    const {\n      updateFunction,\n      reject\n    } = meta; // clear any saved state from previous transaction runs\n\n    transaction._prepare();\n\n    let finalError;\n    let updateFailed;\n    let pendingResult; // run the users custom update functionality\n\n    try {\n      const possiblePromise = updateFunction(transaction); // validate user has returned a promise in their update function\n      // TODO must it actually return a promise? Can't find any usages of it without one...\n\n      if (!possiblePromise || !possiblePromise.then) {\n        finalError = new Error('Update function for `firestore.runTransaction(updateFunction)` must return a Promise.');\n      } else {\n        pendingResult = await possiblePromise;\n      }\n    } catch (exception) {\n      // exception can still be falsey if user `Promise.reject();` 's with no args\n      // so we track the exception with a updateFailed boolean to ensure no fall-through\n      updateFailed = true;\n      finalError = exception;\n    } // reject the final promise and remove from native\n    // update is failed when either the users updateFunction\n    // throws an error or rejects a promise\n\n\n    if (updateFailed || finalError) {\n      // $FlowExpectedError: Reject will always be present\n      return reject(finalError);\n    } // capture the resolved result as we'll need this\n    // to resolve the runTransaction() promise when\n    // native emits that the transaction is final\n\n\n    transaction._pendingResult = pendingResult; // send the buffered update/set/delete commands for native to process\n\n    return getNativeModule(this._firestore).transactionApplyBuffer(id, transaction._commandBuffer);\n  }\n  /**\n   * Handles incoming native transaction error events\n   *\n   * @param event\n   * @private\n   */\n\n\n  _handleError(event) {\n    const {\n      id,\n      error\n    } = event;\n    const {\n      meta\n    } = this._pending[id];\n\n    if (meta && error) {\n      const {\n        code,\n        message\n      } = error; // build a JS error and replace its stack\n      // with the captured one at start of transaction\n      // so it's actually relevant to the user\n\n      const errorWithStack = new Error(message); // $FlowExpectedError: code is needed for Firebase errors\n\n      errorWithStack.code = code; // $FlowExpectedError: stack should be a stack trace\n\n      errorWithStack.stack = `Error: ${message}\\n${meta.stack}`; // $FlowExpectedError: Reject will always be present\n\n      meta.reject(errorWithStack);\n    }\n  }\n  /**\n   * Handles incoming native transaction complete events\n   *\n   * @param event\n   * @private\n   */\n\n\n  _handleComplete(event) {\n    const {\n      id\n    } = event;\n    const {\n      meta,\n      transaction\n    } = this._pending[id];\n\n    if (meta) {\n      const pendingResult = transaction._pendingResult; // $FlowExpectedError: Resolve will always be present\n\n      meta.resolve(pendingResult);\n    }\n  }\n\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}